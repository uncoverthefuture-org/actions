name: CI/CD â€” Build and Deploy Django API

on:
  push:
    branches: [ main, staging, develop ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: build
        uses: uncoverthefuture-org/actions@master
        with:
          subaction: build-and-push

      - name: Deploy Django API
        if: ${{ steps.build.outputs.deploy_enabled == 'true' }}
        uses: uncoverthefuture-org/actions@master
        with:
          subaction: ssh-django-api-deploy
          params_json: |
            {
              "ssh_host": "${{ secrets.SSH_HOST }}",
              "ssh_key":  "${{ secrets.SSH_KEY }}",
              "base_domain": "example.com",
              "domain_prefix_prod": "app",
              "run_db": "false"
            }
        # ssh_user defaults to "root". Provide "ssh_user" in params_json if you need a non-root user.
        # Note: domain config is optional. If neither base_domain nor domain is provided,
        # the Apache vhost step is skipped automatically.
        # Set "run_db": "false" (default) to skip provisioning a local database when you already have a managed DB.

      # Optional: write env file from a secret (env_name defaults from branch; can omit)
      # - uses: uncoverthefuture-org/actions@master
      #   with:
      #     subaction: write-remote-env-file
      #     params_json: |
      #       {
      #         "ssh_host": "${{ secrets.SSH_HOST }}",
      #         "ssh_user": "${{ secrets.SSH_USER }}",
      #         "ssh_key":  "${{ secrets.SSH_KEY }}",
      #         "env_name": "${{ needs.build.outputs.env_name }}",
      #         "env_b64":  "${{ secrets.API_ENV_B64 }}"
      #       }
