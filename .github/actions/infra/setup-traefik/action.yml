name: 'infra: setup-traefik'
description: 'Install Traefik reverse proxy with automatic Let''s Encrypt certificates via Podman.'

inputs:
  ssh_host:
    description: 'Remote host to connect to'
    required: true
  ssh_user:
    description: 'SSH username'
    required: true
  ssh_key:
    description: 'SSH private key for ssh_user'
    required: true
  root_ssh_key:
    description: 'Optional SSH key for root (used when switching users)'
    required: false
  ssh_port:
    description: 'SSH port'
    required: false
    default: '22'
  ssh_fingerprint:
    description: 'Optional server fingerprint verification'
    required: false
  podman_user:
    description: 'Podman user on target host'
    required: false
    default: 'deployer'
  connect_mode:
    description: "Connection mode: auto | root | user"
    required: false
    default: 'auto'
  traefik_email:
    description: "Email used for Let's Encrypt certificates"
    required: true
  traefik_version:
    description: 'Traefik image tag'
    required: false
    default: 'v3.1'
  skip_upload:
    description: 'Skip uploading per-script file (assumes scripts are already deployed via deploy-server-scripts)'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    - name: Check SSH reachability
      id: reach
      shell: bash
      env:
        SSH_HOST: ${{ inputs.ssh_host }}
        SSH_USER: ${{ inputs.ssh_user }}
        SSH_KEY: ${{ inputs.ssh_key }}
        SSH_PORT: ${{ inputs.ssh_port }}
      run: |
        set -euo pipefail
        KEY_FILE="$(mktemp)"
        trap "rm -f '$KEY_FILE'" EXIT
        if printf '%s' "$SSH_KEY" | grep -q '\\n'; then
          printf '%s\n' "$SSH_KEY" | sed 's/\\n/\n/g' > "$KEY_FILE"
        else
          printf '%s\n' "$SSH_KEY" > "$KEY_FILE"
        fi
        chmod 600 "$KEY_FILE"
        if ssh -i "$KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=8 -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" true 2>/dev/null; then
          echo "reachable=true" >> "$GITHUB_OUTPUT"
        else
          echo "reachable=false" >> "$GITHUB_OUTPUT"
        fi
    - name: Stage Traefik script for upload
      if: ${{ steps.reach.outputs.reachable == 'true' && inputs.skip_upload == 'false' }}
      shell: bash
      env:
        ACTION_PATH: ${{ github.action_path }}
        WORKSPACE: ${{ github.workspace }}
      run: |
        set -euo pipefail
        mkdir -p "$WORKSPACE/.uactions_cache"
        SRC_REL="../../scripts/traefik/setup-traefik.sh"
        cp "$ACTION_PATH/$SRC_REL" "$WORKSPACE/.uactions_cache/setup-traefik.sh"

    - name: Upload Traefik script (Option B)
      if: ${{ steps.reach.outputs.reachable == 'true' && inputs.skip_upload == 'false' }}
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ inputs.ssh_host }}
        username: ${{ inputs.ssh_user }}
        key: ${{ inputs.ssh_key }}
        port: ${{ inputs.ssh_port }}
        source: ".uactions_cache/setup-traefik.sh"
        target: "/tmp"
        overwrite: true
        timeout: 15s
        command_timeout: 30s

    - name: Run Traefik script
      if: ${{ steps.reach.outputs.reachable == 'true' }}
      uses: ./.github/actions/podman/remote-podman-exec
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        root_ssh_key: ${{ inputs.root_ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        podman_user: ${{ inputs.podman_user }}
        connect_mode: root
        inline_script: |
          set -euo pipefail
          # Ensure final scripts directory and move uploaded script into place
          sudo mkdir -p /opt/uactions/scripts/traefik
          if [ -f /tmp/setup-traefik.sh ]; then
            sudo mv -f /tmp/setup-traefik.sh /opt/uactions/scripts/traefik/setup-traefik.sh
          fi
          sudo chmod +x /opt/uactions/scripts/traefik/setup-traefik.sh

          # Execute the server-managed script with explicit env vars
          export TRAEFIK_EMAIL='${{ inputs.traefik_email }}'
          export PODMAN_USER='${{ inputs.podman_user }}'
          export TRAEFIK_VERSION='${{ inputs.traefik_version }}'
          /opt/uactions/scripts/traefik/setup-traefik.sh

    - name: Traefik status summary
      if: always()
      shell: bash
      env:
        SSH_HOST: ${{ inputs.ssh_host }}
        SSH_USER: ${{ inputs.ssh_user }}
        SSH_KEY: ${{ inputs.ssh_key }}
        SSH_PORT: ${{ inputs.ssh_port }}
        REACHABLE: ${{ steps.reach.outputs.reachable }}
      run: |
        set -euo pipefail
        
        # Create temporary SSH key file
        KEY_FILE="$(mktemp)"
        trap "rm -f '$KEY_FILE'" EXIT
        
        # Handle newline-escaped SSH keys (convert \n to actual newlines)
        if printf '%s' "$SSH_KEY" | grep -q '\\n'; then
          printf '%s\n' "$SSH_KEY" | sed 's/\\n/\n/g' > "$KEY_FILE"
        else
          printf '%s\n' "$SSH_KEY" > "$KEY_FILE"
        fi
        chmod 600 "$KEY_FILE"

        # SSH remote execution helper
        run_remote() {
          ssh -i "$KEY_FILE" -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "$@" 2>/dev/null || echo "SSH_FAILED"
        }

        # Connectivity section
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ### 🌐 Connectivity
        SUMMARY_EOF
        if [ "${REACHABLE:-false}" = "true" ]; then
          echo "Host reachable" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Host NOT reachable (skipped Traefik setup steps)" >> "$GITHUB_STEP_SUMMARY"
        fi

        # Fetch Traefik container status
        TRAEFIK_PS="$(run_remote 'command -v podman >/dev/null 2>&1 && sudo podman ps --filter name=traefik --format "table {{.ID}}\t{{.Status}}\t{{.Names}}\t{{.Ports}}" || echo "podman not available"' || true)"
        
        # Fetch Traefik container stats (CPU, memory, I/O)
        TRAEFIK_STATS="$(run_remote 'command -v podman >/dev/null 2>&1 && sudo podman stats traefik --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" || echo "stats unavailable"' || true)"
        
        # Fetch recent Traefik logs (last 50 lines)
        TRAEFIK_LOGS="$(run_remote 'command -v podman >/dev/null 2>&1 && sudo podman logs traefik --tail=50 || echo "logs unavailable"' || true)"
        
        # Fetch port listeners on 80/443
        PORTS_LISTEN="$(run_remote 'ss -ltnp 2>/dev/null | grep -E ":80|:443" || echo "no listeners"' || true)"
        
        # Fetch legacy proxy status
        APACHE_STATE="$(run_remote 'systemctl is-active apache2 2>/dev/null || echo "inactive"' || true)"
        NGINX_STATE="$(run_remote 'systemctl is-active nginx 2>/dev/null || echo "inactive"' || true)"

        # Generate GitHub step summary with formatted output
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ### 🚀 Traefik Setup Summary
        
        #### ✅ Container Status
        
        ```
        SUMMARY_EOF
        
        if [ -n "$TRAEFIK_PS" ] && [ "$TRAEFIK_PS" != "SSH_FAILED" ]; then 
          echo "$TRAEFIK_PS" >> "$GITHUB_STEP_SUMMARY"
        else 
          echo "⚠️  Container status unavailable (SSH timeout or podman not available)" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ```
        
        #### 📊 Container Resource Usage
        
        ```
        SUMMARY_EOF
        
        if [ -n "$TRAEFIK_STATS" ] && [ "$TRAEFIK_STATS" != "SSH_FAILED" ]; then 
          echo "$TRAEFIK_STATS" >> "$GITHUB_STEP_SUMMARY"
        else 
          echo "⚠️  Stats unavailable" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ```
        
        #### 🔌 Network Ports (80/443)
        
        ```
        SUMMARY_EOF
        
        if [ -n "$PORTS_LISTEN" ] && [ "$PORTS_LISTEN" != "SSH_FAILED" ]; then 
          echo "$PORTS_LISTEN" >> "$GITHUB_STEP_SUMMARY"
        else 
          echo "⚠️  No listeners on 80/443" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ```
        
        #### 🛑 Legacy Proxies (Apache/Nginx)
        
        | Service | Status |
        |---------|--------|
        SUMMARY_EOF
        
        APACHE_DISPLAY="${APACHE_STATE:-unknown}"
        NGINX_DISPLAY="${NGINX_STATE:-unknown}"
        [ "$APACHE_STATE" = "SSH_FAILED" ] && APACHE_DISPLAY="SSH timeout"
        [ "$NGINX_STATE" = "SSH_FAILED" ] && NGINX_DISPLAY="SSH timeout"
        
        echo "| Apache  | \`$APACHE_DISPLAY\` |" >> "$GITHUB_STEP_SUMMARY"
        echo "| Nginx   | \`$NGINX_DISPLAY\` |" >> "$GITHUB_STEP_SUMMARY"
        
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        
        #### 📋 Recent Traefik Logs (Last 50 lines)
        
        ```log
        SUMMARY_EOF
        
        if [ -n "$TRAEFIK_LOGS" ] && [ "$TRAEFIK_LOGS" != "SSH_FAILED" ]; then 
          echo "$TRAEFIK_LOGS" | head -50 >> "$GITHUB_STEP_SUMMARY"
        else 
          echo "⚠️  Logs unavailable" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << 'SUMMARY_EOF'
        ```
        
        ---
        **Generated at:** `$(date -u +'%Y-%m-%d %H:%M:%S UTC')`
        SUMMARY_EOF
