name: 'infra: setup-traefik'
description: 'Installs and manages Traefik reverse proxy on remote host for automatic HTTPS. Traefik terminates HTTP/S on ports 80/443, so downstream app deployments must avoid publishing host ports when Traefik is enabledâ€”the container scripts emit labels only and skip `-p` mappings in that mode. Let''s Encrypt certificates via Podman.'

inputs:
  ssh_host:
    description: 'Remote host to connect to'
    required: true
  ssh_user:
    description: 'SSH username'
    required: true
  ssh_key:
    description: 'SSH private key for ssh_user'
    required: true
  ssh_port:
    description: 'SSH port'
    required: false
    default: '22'
  ssh_fingerprint:
    description: 'Optional server fingerprint verification'
    required: false
  traefik_email:
    description: "Email used for Let's Encrypt certificates"
    required: false
    default: ''
  traefik_version:
    description: 'Traefik image tag'
    required: false
    default: 'v3.5.4'
  enable_acme:
    description: 'Enable ACME/Let''s Encrypt provisioning (default: true). Set to false to skip cert resolver labels during debugging.'
    required: false
    default: 'true'
  enable_ping:
    description: 'Expose Traefik ping entrypoint for healthchecks (default: true).'
    required: false
    default: 'true'
  use_host_network:
    description: 'Run Traefik with --network host (bypasses publish, useful for debugging port 80 reachability).'
    required: false
    default: 'false'
  network_name:
    description: 'Shared Podman network name to join after container start (default: traefik-network).'
    required: false
    default: 'traefik-network'
  enable_metrics:
    description: 'Enable Prometheus metrics exposure (default: false).'
    required: false
    default: 'false'
  metrics_entrypoint:
    description: 'Entry point name for metrics when enabled (default: metrics).'
    required: false
    default: 'metrics'
  metrics_address:
    description: 'Bind address for metrics entry point (default: :8082).'
    required: false
    default: ':8082'
  acme_dns_provider:
    description: 'Optional ACME DNS challenge provider identifier.'
    required: false
    default: ''
  acme_dns_resolvers:
    description: 'Optional comma-separated DNS resolvers for ACME DNS challenge.'
    required: false
    default: ''
  dns_servers:
    description: 'Optional comma or space-separated DNS servers to set in Traefik container (passed as --dns). Helps avoid DNS timeouts.'
    required: false
    default: ''
  enable_dashboard:
    description: 'Expose Traefik dashboard on port 8080 (requires basic auth hash)'
    required: false
    default: 'false'
  mode:
    description: 'Setup mode: container (default) or quadlet (socket activation)'
    required: false
    default: 'quadlet'
  quadlet_enable_http3:
    description: 'When mode=quadlet, also bind UDP 443 and enable HTTP/3 (default: false)'
    required: false
    default: 'false'
  dashboard_user:
    description: 'Basic auth username for Traefik dashboard (required if dashboard enabled)'
    required: false
    default: ''
  dashboard_password_bcrypt:
    description: 'Bcrypt hash (htpasswd -nB) for Traefik dashboard user (required if dashboard enabled)'
    required: false
    default: ''
  dashboard_publish_modes:
    description: 'CSV modes for dashboard exposure: http8080, https8080, subdomain, or both (https8080,subdomain)'
    required: false
    default: ''
  dashboard_host:
    description: 'FQDN for dashboard when using subdomain mode (e.g., traefik.example.com)'
    required: false
    default: ''
  dashboard_password:
    description: 'Plain password to hash for dashboard auth (alternative to bcrypt hash)'
    required: false
    default: ''
  dashboard_users_b64:
    description: 'Base64-encoded users file contents; overrides other credential inputs'
    required: false
    default: ''
  skip_upload:
    description: 'Skip uploading per-script file (assumes scripts are already deployed via deploy-server-scripts)'
    required: false
    default: 'true'
  upload_policy:
    description: 'Script upload policy: auto|always|skip'
    required: false
    default: 'auto'
  summary_mode:
    description: 'Summary rendering mode: on_change|on_failure|always|never'
    required: false
    default: 'on_change'
  force_restart:
    description: 'Force restart/recreate Traefik even if confighash matches'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Check SSH reachability
      id: reach
      shell: bash
      env:
        SSH_HOST: ${{ inputs.ssh_host }}
        SSH_USER: ${{ inputs.ssh_user }}
        SSH_KEY: ${{ inputs.ssh_key }}
        SSH_PORT: ${{ inputs.ssh_port }}
      run: |
        set -euo pipefail
        KEY_FILE="$(mktemp)"
        trap "rm -f '$KEY_FILE'" EXIT
        if printf '%s' "$SSH_KEY" | grep -q '\\n'; then
          printf '%s\n' "$SSH_KEY" | sed 's/\\n/\n/g' > "$KEY_FILE"
        else
          printf '%s\n' "$SSH_KEY" > "$KEY_FILE"
        fi
        chmod 600 "$KEY_FILE"
        if ssh -i "$KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=8 -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" true 2>/dev/null; then
          echo "reachable=true" >> "$GITHUB_OUTPUT"
        else
          echo "reachable=false" >> "$GITHUB_OUTPUT"
        fi
    - name: Probe Traefik state
      id: probe_traefik
      if: ${{ steps.reach.outputs.reachable == 'true' }}
      uses: ./.github/actions/infra/traefik-probe
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        traefik_version: ${{ inputs.traefik_version }}
        enable_acme: ${{ inputs.enable_acme }}
        traefik_email: ${{ inputs.traefik_email }}
        acme_dns_provider: ${{ inputs.acme_dns_provider }}
        acme_dns_resolvers: ${{ inputs.acme_dns_resolvers }}
        enable_ping: ${{ inputs.enable_ping }}
        enable_dashboard: ${{ inputs.enable_dashboard }}
        dashboard_user: ${{ inputs.dashboard_user }}
        dashboard_publish_modes: ${{ inputs.dashboard_publish_modes }}
        dashboard_host: ${{ inputs.dashboard_host }}
        enable_metrics: ${{ inputs.enable_metrics }}
        metrics_entrypoint: ${{ inputs.metrics_entrypoint }}
        metrics_address: ${{ inputs.metrics_address }}
        use_host_network: ${{ inputs.use_host_network }}
        network_name: ${{ inputs.network_name }}
        dns_servers: ${{ inputs.dns_servers }}

    # Fast-path: Only upload scripts when we might run setup
    # We probe first, then conditionally upload if force_restart=true or not up_to_date
    - name: Upload/Update Traefik scripts (smart)
      if: ${{ steps.reach.outputs.reachable == 'true' && (inputs.force_restart == 'true' || steps.probe_traefik.outputs.up_to_date != 'true') }}
      uses: ./.github/actions/infra/traefik-upload-scripts
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        skip_upload: ${{ inputs.skip_upload }}
        upload_policy: ${{ inputs.upload_policy }}

    - name: Run Traefik setup (when needed)
      if: ${{ steps.reach.outputs.reachable == 'true' && (inputs.force_restart == 'true' || steps.probe_traefik.outputs.up_to_date != 'true') }}
      uses: ./.github/actions/infra/traefik-run-setup
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        mode: ${{ inputs.mode }}
        traefik_email: ${{ inputs.traefik_email }}
        traefik_version: ${{ inputs.traefik_version }}
        enable_acme: ${{ inputs.enable_acme }}
        enable_ping: ${{ inputs.enable_ping }}
        use_host_network: ${{ inputs.use_host_network }}
        network_name: ${{ inputs.network_name }}
        enable_metrics: ${{ inputs.enable_metrics }}
        metrics_entrypoint: ${{ inputs.metrics_entrypoint }}
        metrics_address: ${{ inputs.metrics_address }}
        acme_dns_provider: ${{ inputs.acme_dns_provider }}
        acme_dns_resolvers: ${{ inputs.acme_dns_resolvers }}
        dns_servers: ${{ inputs.dns_servers }}
        enable_dashboard: ${{ inputs.enable_dashboard }}
        dashboard_user: ${{ inputs.dashboard_user }}
        dashboard_password_bcrypt: ${{ inputs.dashboard_password_bcrypt }}
        dashboard_publish_modes: ${{ inputs.dashboard_publish_modes }}
        dashboard_host: ${{ inputs.dashboard_host }}
        dashboard_password: ${{ inputs.dashboard_password }}
        dashboard_users_b64: ${{ inputs.dashboard_users_b64 }}
        quadlet_enable_http3: ${{ inputs.quadlet_enable_http3 }}
        force_restart: ${{ inputs.force_restart }}

    - name: Traefik status summary
      if: ${{ inputs.summary_mode == 'always' || (inputs.summary_mode == 'on_failure' && failure()) || (inputs.summary_mode == 'on_change' && steps.probe_traefik.outputs.up_to_date != 'true') }}
      uses: ./.github/actions/infra/traefik-summary
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        reachable: ${{ steps.reach.outputs.reachable }}

    - name: Configure UFW for Traefik dashboard
      if: ${{ inputs.enable_dashboard == 'true' }}
      uses: ./.github/actions/infra/configure-ufw
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        enable_podman_forward: 'true'
        route_ports: '8080'
        set_forward_policy_accept: 'true'
        skip_upload: 'false'

    # Add step summary with dashboard warnings and configuration details
    # NOTE: Added to support task "add step summary and warnings"
    # from traefik-dashboard-and-domain-fix-eventkaban.md plan
    - name: Traefik setup summary
      if: always()
      shell: bash
      env:
        ENABLE_DASHBOARD: ${{ inputs.enable_dashboard }}
        DASHBOARD_PUBLISH_MODES: ${{ inputs.dashboard_publish_modes }}
        DASHBOARD_HOST: ${{ inputs.dashboard_host }}
        DASHBOARD_PASSWORD: ${{ inputs.dashboard_password }}
        DASHBOARD_USERS_B64: ${{ inputs.dashboard_users_b64 }}
        ENABLE_ACME: ${{ inputs.enable_acme }}
        TRAEFIK_EMAIL: ${{ inputs.traefik_email }}
        UP_TO_DATE: ${{ steps.probe_traefik.outputs.up_to_date }}
      run: |
        {
          echo "## ðŸ”§ Traefik Setup Summary"
          echo ""
          
          if [[ "$UP_TO_DATE" == "true" ]]; then
            echo "âœ… **Status**: Traefik is up-to-date (no changes needed)"
          else
            echo "ðŸ”„ **Status**: Traefik was updated or recreated"
          fi
          echo ""
          
          # Dashboard configuration
          if [[ "$ENABLE_DASHBOARD" == "true" || -n "$DASHBOARD_PUBLISH_MODES" ]]; then
            echo "### ðŸ“Š Dashboard Configuration"
            echo ""
            MODES="${DASHBOARD_PUBLISH_MODES:-http8080}"
            echo "**Publish Modes**: ${MODES}"
            if [[ -n "$DASHBOARD_HOST" ]]; then
              echo "**Dashboard Host**: ${DASHBOARD_HOST}"
            fi
            echo ""
            
            # Credentials warning
            if [[ -z "$DASHBOARD_PASSWORD" && -z "$DASHBOARD_USERS_B64" ]]; then
              echo "### âš ï¸ **SECURITY WARNING: Default Dashboard Credentials**"
              echo ""
              echo "ðŸ” Traefik dashboard is using **default credentials**: \`admin/12345678\`"
              echo ""
              echo "**âš ï¸ CHANGE THIS IMMEDIATELY!**"
              echo ""
              echo "**To update credentials:**"
              echo "1. Set \`dashboard_password\` input in your workflow, OR"
              echo "2. Set \`dashboard_users_b64\` with pre-hashed credentials"
              echo ""
              echo "**Note**: Changing the password requires recreating the Traefik container."
              echo ""
              echo "**Quick command to hash a new password:**"
              echo "\`\`\`bash"
              echo "htpasswd -nB admin yourNewPassword | base64 -w0"
              echo "\`\`\`"
              echo ""
            else
              echo "âœ… Custom credentials configured"
              echo ""
            fi
          fi
          
          # ACME configuration
          if [[ "$ENABLE_ACME" == "true" ]]; then
            echo "### ðŸ”’ ACME/Let's Encrypt"
            echo ""
            echo "**Enabled**: Yes"
            if [[ -n "$TRAEFIK_EMAIL" ]]; then
              echo "**Email**: ${TRAEFIK_EMAIL}"
            fi
            echo ""
          fi
          
          # Cloudflare caveat for https8080
          if [[ "$DASHBOARD_PUBLISH_MODES" == *"https8080"* ]]; then
            echo "### âš ï¸ Cloudflare Proxy Caveat"
            echo ""
            echo "**Mode \`https8080\` is NOT proxied by Cloudflare.**"
            echo ""
            echo "To access dashboard on port 8080 with HTTPS:"
            echo "- Use DNS grey-cloud (direct connection), OR"
            echo "- Access via server IP directly, OR"
            echo "- Add hosts file mapping"
            echo ""
            echo "**Recommended**: Use \`subdomain\` mode on port 443 for Cloudflare compatibility."
            echo ""
          fi
          fi

          # Network / firewall checklist
          echo "### ðŸŒ Network & Firewall Checklist"
          echo ""
          echo "- Ensure the server firewall (e.g., UFW) allows inbound TCP on ports 80 and 443 for Traefik." 
          echo "- If the Traefik dashboard is enabled on 8080, allow TCP 8080 as well (or restrict to trusted IPs)." 
          echo "- If you use Portainer, ensure TCP ${PORTAINER_HTTPS_PORT:-9443} is allowed (or equivalent configured port)." 
          echo "- If you use Webmin, ensure TCP 10000 is allowed." 
          echo "- In cloud environments (AWS Security Groups, GCP firewall rules, Azure NSGs, etc.), open these ports to your desired source IP ranges; UFW alone is not enough if the cloud firewall blocks them." 
          echo ""

        } >> "$GITHUB_STEP_SUMMARY"
        
        # Also emit workflow-level warnings
        if [[ "$ENABLE_DASHBOARD" == "true" || -n "$DASHBOARD_PUBLISH_MODES" ]]; then
          if [[ -z "$DASHBOARD_PASSWORD" && -z "$DASHBOARD_USERS_B64" ]]; then
            echo "::warning::Traefik dashboard using DEFAULT credentials (admin/12345678). Change immediately via dashboard_password or dashboard_users_b64 input!"
          fi
        fi
