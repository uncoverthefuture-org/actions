name: 'infra: setup-traefik'
description: 'Installs and manages Traefik reverse proxy on remote host for automatic HTTPS. Traefik terminates HTTP/S on ports 80/443, so downstream app deployments must avoid publishing host ports when Traefik is enabledâ€”the container scripts emit labels only and skip `-p` mappings in that mode. Let''s Encrypt certificates via Podman.'

inputs:
  ssh_host:
    description: 'Remote host to connect to'
    required: true
  ssh_user:
    description: 'SSH username'
    required: true
  ssh_key:
    description: 'SSH private key for ssh_user'
    required: true
  ssh_port:
    description: 'SSH port'
    required: false
    default: '22'
  ssh_fingerprint:
    description: 'Optional server fingerprint verification'
    required: false
  traefik_email:
    description: "Email used for Let's Encrypt certificates"
    required: false
    default: ''
  traefik_version:
    description: 'Traefik image tag'
    required: false
    default: 'v3.5.4'
  enable_acme:
    description: 'Enable ACME/Let''s Encrypt provisioning (default: true). Set to false to skip cert resolver labels during debugging.'
    required: false
    default: 'true'
  enable_ping:
    description: 'Expose Traefik ping entrypoint for healthchecks (default: true).'
    required: false
    default: 'true'
  use_host_network:
    description: 'Run Traefik with --network host (bypasses publish, useful for debugging port 80 reachability).'
    required: false
    default: 'false'
  network_name:
    description: 'Shared Podman network name to join after container start (default: traefik-network).'
    required: false
    default: 'traefik-network'
  enable_metrics:
    description: 'Enable Prometheus metrics exposure (default: false).'
    required: false
    default: 'false'
  metrics_entrypoint:
    description: 'Entry point name for metrics when enabled (default: metrics).'
    required: false
    default: 'metrics'
  metrics_address:
    description: 'Bind address for metrics entry point (default: :8082).'
    required: false
    default: ':8082'
  acme_dns_provider:
    description: 'Optional ACME DNS challenge provider identifier.'
    required: false
    default: ''
  acme_dns_resolvers:
    description: 'Optional comma-separated DNS resolvers for ACME DNS challenge.'
    required: false
    default: ''
  dns_servers:
    description: 'Optional comma or space-separated DNS servers to set in Traefik container (passed as --dns). Helps avoid DNS timeouts.'
    required: false
    default: ''
  enable_dashboard:
    description: 'Expose Traefik dashboard on port 8080 (requires basic auth hash)'
    required: false
    default: 'false'
  mode:
    description: 'Setup mode: container (default) or quadlet (socket activation)'
    required: false
    default: 'container'
  quadlet_enable_http3:
    description: 'When mode=quadlet, also bind UDP 443 and enable HTTP/3 (default: false)'
    required: false
    default: 'false'
  dashboard_user:
    description: 'Basic auth username for Traefik dashboard (required if dashboard enabled)'
    required: false
    default: ''
  dashboard_password_bcrypt:
    description: 'Bcrypt hash (htpasswd -nB) for Traefik dashboard user (required if dashboard enabled)'
    required: false
    default: ''
  skip_upload:
    description: 'Skip uploading per-script file (assumes scripts are already deployed via deploy-server-scripts)'
    required: false
    default: 'true'
  upload_policy:
    description: 'Script upload policy: auto|always|skip'
    required: false
    default: 'auto'
  summary_mode:
    description: 'Summary rendering mode: on_change|on_failure|always|never'
    required: false
    default: 'on_change'
  force_restart:
    description: 'Force restart/recreate Traefik even if confighash matches'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Check SSH reachability
      id: reach
      shell: bash
      env:
        SSH_HOST: ${{ inputs.ssh_host }}
        SSH_USER: ${{ inputs.ssh_user }}
        SSH_KEY: ${{ inputs.ssh_key }}
        SSH_PORT: ${{ inputs.ssh_port }}
      run: |
        set -euo pipefail
        KEY_FILE="$(mktemp)"
        trap "rm -f '$KEY_FILE'" EXIT
        if printf '%s' "$SSH_KEY" | grep -q '\\n'; then
          printf '%s\n' "$SSH_KEY" | sed 's/\\n/\n/g' > "$KEY_FILE"
        else
          printf '%s\n' "$SSH_KEY" > "$KEY_FILE"
        fi
        chmod 600 "$KEY_FILE"
        if ssh -i "$KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=8 -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" true 2>/dev/null; then
          echo "reachable=true" >> "$GITHUB_OUTPUT"
        else
          echo "reachable=false" >> "$GITHUB_OUTPUT"
        fi
    - name: Upload/Update Traefik scripts (smart)
      if: ${{ steps.reach.outputs.reachable == 'true' }}
      uses: ./.github/actions/infra/traefik-upload-scripts
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        skip_upload: ${{ inputs.skip_upload }}
        upload_policy: ${{ inputs.upload_policy }}

    - name: Probe Traefik state
      id: probe_traefik
      if: ${{ steps.reach.outputs.reachable == 'true' }}
      uses: ./.github/actions/infra/traefik-probe
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        traefik_version: ${{ inputs.traefik_version }}
        enable_acme: ${{ inputs.enable_acme }}
        traefik_email: ${{ inputs.traefik_email }}
        acme_dns_provider: ${{ inputs.acme_dns_provider }}
        acme_dns_resolvers: ${{ inputs.acme_dns_resolvers }}
        enable_ping: ${{ inputs.enable_ping }}
        enable_dashboard: ${{ inputs.enable_dashboard }}
        dashboard_user: ${{ inputs.dashboard_user }}
        enable_metrics: ${{ inputs.enable_metrics }}
        metrics_entrypoint: ${{ inputs.metrics_entrypoint }}
        metrics_address: ${{ inputs.metrics_address }}
        use_host_network: ${{ inputs.use_host_network }}
        network_name: ${{ inputs.network_name }}
        dns_servers: ${{ inputs.dns_servers }}

    - name: Run Traefik setup (when needed)
      if: ${{ steps.reach.outputs.reachable == 'true' && (inputs.force_restart == 'true' || steps.probe_traefik.outputs.up_to_date != 'true') }}
      uses: ./.github/actions/infra/traefik-run-setup
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        mode: ${{ inputs.mode }}
        traefik_email: ${{ inputs.traefik_email }}
        traefik_version: ${{ inputs.traefik_version }}
        enable_acme: ${{ inputs.enable_acme }}
        enable_ping: ${{ inputs.enable_ping }}
        use_host_network: ${{ inputs.use_host_network }}
        network_name: ${{ inputs.network_name }}
        enable_metrics: ${{ inputs.enable_metrics }}
        metrics_entrypoint: ${{ inputs.metrics_entrypoint }}
        metrics_address: ${{ inputs.metrics_address }}
        acme_dns_provider: ${{ inputs.acme_dns_provider }}
        acme_dns_resolvers: ${{ inputs.acme_dns_resolvers }}
        dns_servers: ${{ inputs.dns_servers }}
        enable_dashboard: ${{ inputs.enable_dashboard }}
        dashboard_user: ${{ inputs.dashboard_user }}
        dashboard_password_bcrypt: ${{ inputs.dashboard_password_bcrypt }}
        quadlet_enable_http3: ${{ inputs.quadlet_enable_http3 }}
        force_restart: ${{ inputs.force_restart }}

    - name: Traefik status summary
      if: ${{ inputs.summary_mode == 'always' || (inputs.summary_mode == 'on_failure' && failure()) || (inputs.summary_mode == 'on_change' && steps.probe_traefik.outputs.up_to_date != 'true') }}
      uses: ./.github/actions/infra/traefik-summary
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        reachable: ${{ steps.reach.outputs.reachable }}

    - name: Configure UFW for Traefik dashboard
      if: ${{ inputs.enable_dashboard == 'true' }}
      uses: ./.github/actions/infra/configure-ufw
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        enable_podman_forward: 'true'
        route_ports: '8080'
        set_forward_policy_accept: 'true'
        skip_upload: 'false'
