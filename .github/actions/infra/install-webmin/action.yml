name: 'infra: install-webmin'
description: 'Install Webmin and/or Usermin on Ubuntu/Debian host'

inputs:
  ssh_host:
    description: 'SSH host'
    required: true
  ssh_user:
    description: 'SSH username (non-root)'
    required: true
  ssh_key:
    description: 'SSH private key for non-root user'
    required: true
  root_ssh_key:
    description: 'SSH private key for root (optional)'
    required: false
  ssh_port:
    description: 'SSH port'
    required: false
    default: '22'
  ssh_fingerprint:
    description: 'Server SSH host key fingerprint'
    required: false
  podman_user:
    description: 'User on remote host'
    required: false
    default: 'deployer'
  connect_mode:
    description: "How to connect: 'auto' (default), 'root', or 'user'"
    required: false
    default: 'auto'
  install_webmin:
    description: 'Whether to install Webmin'
    required: false
    default: 'false'
  install_usermin:
    description: 'Whether to install Usermin'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Install Webmin/Usermin
      uses: uncoverthefuture-org/actions/.github/actions/podman/remote-podman-exec@v1.0.25
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        root_ssh_key: ${{ inputs.root_ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        podman_user: ${{ inputs.podman_user }}
        connect_mode: ${{ inputs.connect_mode }}
        source_env: 'false'
        fail_if_env_missing: 'false'
        inline_script: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y gnupg wget apt-transport-https software-properties-common
          if [ ! -f /usr/share/keyrings/webmin.gpg ]; then
            wget -qO- https://download.webmin.com/jcameron-key.asc | gpg --dearmor -o /usr/share/keyrings/webmin.gpg
            echo 'deb [signed-by=/usr/share/keyrings/webmin.gpg] https://download.webmin.com/download/repository sarge contrib' > /etc/apt/sources.list.d/webmin.list
            apt-get update -y
          fi
          if [ "${{ inputs.install_webmin }}" = "true" ]; then
            apt-get install -y webmin
            systemctl enable webmin || true
            systemctl restart webmin || true
          fi
          if [ "${{ inputs.install_usermin }}" = "true" ]; then
            apt-get install -y usermin
            systemctl enable usermin || true
            systemctl restart usermin || true
          fi
