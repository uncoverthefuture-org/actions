name: 'infra: install-webmin'
description: 'Install Webmin and/or Usermin on Ubuntu/Debian host'

inputs:
  ssh_host:
    description: 'SSH host'
    required: true
  ssh_user:
    description: 'SSH username (non-root)'
    required: true
  ssh_key:
    description: 'SSH private key for non-root user'
    required: true
  root_ssh_key:
    description: 'SSH private key for root (optional)'
    required: false
  ssh_port:
    description: 'SSH port'
    required: false
    default: '22'
  ssh_fingerprint:
    description: 'Server SSH host key fingerprint'
    required: false
  podman_user:
    description: 'User on remote host'
    required: false
    default: 'deployer'
  connect_mode:
    description: "How to connect: 'auto' (default), 'root', or 'user'"
    required: false
    default: 'auto'
  install_webmin:
    description: 'Whether to install Webmin'
    required: false
    default: 'false'
  install_usermin:
    description: 'Whether to install Usermin'
    required: false
    default: 'false'
  skip_upload:
    description: 'Skip staging/upload (assumes scripts deployed via deploy-server-scripts)'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    # Stage: Copy script from action path to workspace
    - name: Stage install-webmin script
      if: ${{ inputs.skip_upload != 'true' }}
      shell: bash
      env:
        ACTION_PATH: ${{ github.action_path }}
        WORKSPACE: ${{ github.workspace }}
      run: |
        set -euo pipefail
        mkdir -p "$WORKSPACE/.uactions_cache"
        cp "$ACTION_PATH/../../scripts/infra/install-webmin.sh" "$WORKSPACE/.uactions_cache/install-webmin.sh"

    # Upload: Transfer script to remote /tmp via scp
    - name: Upload install-webmin script
      if: ${{ inputs.skip_upload != 'true' }}
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ inputs.ssh_host }}
        username: ${{ inputs.ssh_user }}
        key: ${{ inputs.ssh_key }}
        port: ${{ inputs.ssh_port }}
        source: ".uactions_cache/install-webmin.sh"
        target: "/tmp"
        overwrite: true

    # Execute: Move to /opt/uactions/scripts/, chmod, run
    - name: Execute install-webmin
      uses: ./.github/actions/podman/remote-podman-exec
      with:
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ inputs.ssh_key }}
        root_ssh_key: ${{ inputs.root_ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_fingerprint: ${{ inputs.ssh_fingerprint }}
        podman_user: ${{ inputs.podman_user }}
        connect_mode: ${{ inputs.connect_mode }}
        source_env: 'false'
        fail_if_env_missing: 'false'
        inline_script: |
          set -euo pipefail
          # Move script from /tmp to /opt/uactions/scripts/
          sudo mkdir -p /opt/uactions/scripts/infra
          if [ -f /tmp/install-webmin.sh ]; then
            sudo mv -f /tmp/install-webmin.sh /opt/uactions/scripts/infra/install-webmin.sh
          fi
          sudo chmod +x /opt/uactions/scripts/infra/install-webmin.sh
          
          # Export toggles for script
          export INSTALL_WEBMIN='${{ inputs.install_webmin }}'
          export INSTALL_USERMIN='${{ inputs.install_usermin }}'

          # Execute server-managed script
          /opt/uactions/scripts/infra/install-webmin.sh
